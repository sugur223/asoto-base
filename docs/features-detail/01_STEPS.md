# あそとステップ管理機能 - 詳細設計

## 1. 機能概要

ユーザーが設定した目標を小さなステップに分解し、ゲーミフィケーション要素を取り入れながら継続的な行動を促進する機能。

## 2. ユーザーストーリー

### 初心者ユーザー（田中さん）のケース

**背景**
- 会社員、30代
- 社外活動に興味があるが、何から始めればいいかわからない
- 継続が苦手

**ストーリー**
1. ダッシュボードで「新しい目標を設定しましょう」というカードが表示される
2. 「目標を作成」ボタンをクリック
3. 目標テンプレートから「イベントに参加する」を選択
4. システムが以下のステップを自動提案：
   - ステップ1: プロフィールを完成させる（所要時間: 10分）
   - ステップ2: 興味のあるタグを3つ選ぶ（所要時間: 5分）
   - ステップ3: 今月のイベント一覧を見る（所要時間: 10分）
   - ステップ4: 気になるイベントを1つ選んで参加申込する（所要時間: 5分）
5. ステップ1を完了すると、10ポイント獲得 + プログレスバーが25%進む
6. 連続3日間ログインで「継続の一歩」バッジを獲得

### アクティブユーザー（佐藤さん）のケース

**背景**
- すでに複数のイベントに参加経験あり
- 自分でプロジェクトを立ち上げたい

**ストーリー**
1. カスタム目標を作成：「コミュニティ内で読書会を立ち上げる」
2. 自分でステップを定義：
   - ステップ1: 読書会の企画書を作る
   - ステップ2: 興味がありそうな5人にDMで声をかける
   - ステップ3: 日程調整をする
   - ステップ4: イベントページを作成する
   - ステップ5: 初回読書会を開催する
3. 各ステップに期限とメモを追加
4. ステップ2完了時に、システムが「この人も興味があるかも」とマッチング提案

## 3. 画面設計

### 3.1 目標一覧画面（/steps）

```
┌─────────────────────────────────────────────────────────┐
│  あそとステップ                                 [+ 新規作成] │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  フィルター: [すべて ▼] [関係性] [多動性] [感受性]        │
│  並び替え: [更新日 ▼]                                    │
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │ 🎯 イベントに参加する            進捗: 75% │        │
│  │    [■■■□] 4/5ステップ完了                  │        │
│  │    次: ステップ5を完了する                   │        │
│  │    期限: 2025-11-20  カテゴリ: 関係性        │        │
│  │    [詳細を見る]                              │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │ 📚 読書会を立ち上げる            進捗: 40% │        │
│  │    [■■□□□] 2/5ステップ完了                │        │
│  │    次: 日程調整をする                        │        │
│  │    期限: 2025-12-01  カテゴリ: 多動性        │        │
│  │    [詳細を見る]                              │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │ ✅ 副業で月5万円稼ぐ             完了済み  │        │
│  │    [■■■■■] 5/5ステップ完了              │        │
│  │    達成日: 2025-10-15                        │        │
│  │    獲得: 100ポイント + 「副業マスター」バッジ │        │
│  │    [振り返りを見る]                          │        │
│  └────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────┘
```

### 3.2 目標詳細画面（/steps/:id）

```
┌─────────────────────────────────────────────────────────┐
│  ← 戻る            📚 読書会を立ち上げる          [編集] │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  進捗状況                                               │
│  ┌────────────────────────────────────────────┐        │
│  │  [■■■■□□□□□□] 40%                    │        │
│  │  2/5 ステップ完了                            │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  目標詳細                                               │
│  ・カテゴリ: 多動性                                     │
│  ・期限: 2025-12-01                                     │
│  ・作成日: 2025-11-01                                   │
│                                                         │
│  ステップ一覧                                           │
│  ┌────────────────────────────────────────────┐        │
│  │ ✅ 1. 読書会の企画書を作る                   │        │
│  │    完了日: 2025-11-05                        │        │
│  │    [振り返りを見る]                          │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │ ✅ 2. 興味がありそうな5人にDMで声をかける    │        │
│  │    完了日: 2025-11-10                        │        │
│  │    メモ: 田中さん、鈴木さん、山田さんに連絡済み│        │
│  │    [振り返りを見る]                          │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │ ⏳ 3. 日程調整をする              [完了する] │        │
│  │    期限: 2025-11-18                          │        │
│  │    所要時間: 約30分                          │        │
│  │    [メモを追加]                              │        │
│  │                                              │        │
│  │    💡 ヒント: Googleカレンダー連携で        │        │
│  │       みんなの空き時間を確認できます         │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │ ⬜ 4. イベントページを作成する               │        │
│  │    期限: 2025-11-25                          │        │
│  │    所要時間: 約20分                          │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │ ⬜ 5. 初回読書会を開催する                   │        │
│  │    期限: 2025-12-01                          │        │
│  │    所要時間: 約2時間                         │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  関連する活動                                           │
│  ・内省ログ: 2件                                        │
│  ・関連するイベント: 0件                                │
│  ・関連するプロジェクト: 0件                            │
└─────────────────────────────────────────────────────────┘
```

### 3.3 目標作成フロー（/steps/new）

#### ステップ1: テンプレート選択

```
┌─────────────────────────────────────────────────────────┐
│  新しい目標を作成                                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  テンプレートから選ぶ、またはカスタム目標を作成します   │
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐│
│  │ 🤝 関係性     │  │ 🚀 多動性     │  │ 💭 感受性     ││
│  ├──────────────┤  ├──────────────┤  ├──────────────┤│
│  │イベントに    │  │プロジェクトを│  │内省の習慣を  ││
│  │参加する      │  │立ち上げる    │  │つける        ││
│  │              │  │              │  │              ││
│  │新しい人と    │  │副業を始める  │  │AIコーチング  ││
│  │出会う        │  │              │  │を活用する    ││
│  │              │  │スキルアップ  │  │              ││
│  │メンターを    │  │する          │  │週次レビューを││
│  │見つける      │  │              │  │行う          ││
│  └──────────────┘  └──────────────┘  └──────────────┘│
│                                                         │
│  ┌────────────────────────────────────────────┐        │
│  │ ✏️ カスタム目標を作成する                    │        │
│  └────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────┘
```

#### ステップ2: 目標詳細入力（テンプレート選択時）

```
┌─────────────────────────────────────────────────────────┐
│  目標作成: イベントに参加する                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  目標のタイトル                                         │
│  ┌────────────────────────────────────────────┐        │
│  │ 今月中にイベントに参加する                   │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  カテゴリ                                               │
│  ◉ 関係性  ○ 多動性  ○ 感受性                         │
│                                                         │
│  期限                                                   │
│  ┌────────────┐                                        │
│  │ 2025-11-30 │ 📅                                     │
│  └────────────┘                                        │
│                                                         │
│  推奨ステップ（編集可能）                               │
│  ┌────────────────────────────────────────────┐        │
│  │ 1. ✅ プロフィールを完成させる                │        │
│  │    所要時間: 10分                            │        │
│  │                                              │        │
│  │ 2. ⬜ 興味のあるタグを3つ選ぶ                │        │
│  │    所要時間: 5分                             │        │
│  │                                              │        │
│  │ 3. ⬜ 今月のイベント一覧を見る               │        │
│  │    所要時間: 10分                            │        │
│  │                                              │        │
│  │ 4. ⬜ イベントに参加申込する                 │        │
│  │    所要時間: 5分                             │        │
│  │                                              │        │
│  │ [+ ステップを追加]                           │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│           [キャンセル]          [目標を作成]           │
└─────────────────────────────────────────────────────────┘
```

#### ステップ3: カスタム目標作成

```
┌─────────────────────────────────────────────────────────┐
│  カスタム目標を作成                                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  目標のタイトル *                                       │
│  ┌────────────────────────────────────────────┐        │
│  │ 読書会を立ち上げる                           │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  目標の説明（任意）                                     │
│  ┌────────────────────────────────────────────┐        │
│  │ コミュニティ内で月1回の読書会を開催し、      │        │
│  │ 知的好奇心を持つ仲間とつながりたい           │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  カテゴリ *                                             │
│  ○ 関係性  ◉ 多動性  ○ 感受性                         │
│                                                         │
│  期限                                                   │
│  ┌────────────┐                                        │
│  │ 2025-12-01 │ 📅                                     │
│  └────────────┘                                        │
│                                                         │
│  ステップを追加                                         │
│  ┌────────────────────────────────────────────┐        │
│  │ [+ 新しいステップを追加]                     │        │
│  │                                              │        │
│  │ 💡 AIにステップを提案してもらう              │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│           [キャンセル]          [次へ: ステップ設定]    │
└─────────────────────────────────────────────────────────┘
```

## 4. データモデル

### Goal（目標）

```typescript
interface Goal {
  id: string;
  userId: string;
  title: string;
  description?: string;
  category: 'relationship' | 'activity' | 'sensitivity'; // 関係性/多動性/感受性
  status: 'active' | 'completed' | 'archived';
  progress: number; // 0-100
  dueDate?: Date;
  completedAt?: Date;
  createdAt: Date;
  updatedAt: Date;

  // Relations
  steps: Step[];
  logs: Log[];
}
```

### Step（ステップ）

```typescript
interface Step {
  id: string;
  goalId: string;
  order: number; // 順序
  title: string;
  description?: string;
  estimatedMinutes?: number; // 所要時間（分）
  status: 'pending' | 'in_progress' | 'completed' | 'skipped';
  dueDate?: Date;
  completedAt?: Date;
  createdAt: Date;
  updatedAt: Date;

  // Metadata
  notes?: string; // ユーザーのメモ
  points?: number; // 完了時の獲得ポイント

  // Relations
  goal: Goal;
  completionLog?: Log; // 完了時の振り返りログ
}
```

## 5. ユースケース詳細

### UC-1: 目標を作成する

**前提条件**
- ユーザーがログイン済み

**正常フロー**
1. ユーザーが「+ 新規作成」ボタンをクリック
2. システムがテンプレート選択画面を表示
3. ユーザーがテンプレートを選択（or カスタム目標を選択）
4. システムが目標作成フォームを表示（テンプレートの場合は推奨ステップ付き）
5. ユーザーが目標情報を入力
6. ユーザーがステップを追加/編集（任意）
7. ユーザーが「目標を作成」ボタンをクリック
8. システムが目標とステップをデータベースに保存
9. システムが目標詳細画面にリダイレクト
10. システムが「目標を作成しました！」という通知を表示

**代替フロー**
- 3a. ユーザーが「AIに提案してもらう」を選択
  - 3a1. システムがユーザーのプロフィール、過去の活動履歴を分析
  - 3a2. AIが目標とステップを提案
  - 3a3. ユーザーが提案を編集して確定

**事後条件**
- 新しい目標がデータベースに保存される
- ダッシュボードに新しい目標が表示される
- 「目標作成」アクションで5ポイント獲得

### UC-2: ステップを完了する

**前提条件**
- ユーザーがログイン済み
- 完了していないステップが存在する

**正常フロー**
1. ユーザーが目標詳細画面でステップの「完了する」ボタンをクリック
2. システムが確認ダイアログを表示
   - 「このステップを完了しますか？」
   - 「完了後、振り返りログを書くことをおすすめします」
   - [キャンセル] [完了する] [完了 & 振り返り]
3. ユーザーが「完了する」または「完了 & 振り返り」を選択
4. システムがステップのステータスを「completed」に更新
5. システムがポイントを付与（ステップの難易度に応じて5-20pt）
6. システムが目標の進捗率を再計算
7. システムが完了アニメーションを表示（チェックマーク、紙吹雪など）
8. システムが「ステップを完了しました！+10pt」という通知を表示
9. （「完了 & 振り返り」を選択した場合）システムが内省ログ作成画面を表示

**代替フロー**
- 7a. 全ステップ完了時
  - 7a1. 目標のステータスを「completed」に更新
  - 7a2. ボーナスポイントを付与（目標の難易度に応じて50-200pt）
  - 7a3. バッジを付与（該当する場合）
  - 7a4. 「目標達成おめでとうございます！」という祝福画面を表示

**事後条件**
- ステップが完了状態になる
- ポイントが付与される
- 目標の進捗率が更新される
- （全ステップ完了時）目標が完了状態になる

### UC-3: ステップをスキップする

**前提条件**
- ユーザーがログイン済み
- 完了していないステップが存在する

**正常フロー**
1. ユーザーがステップの「...」メニューをクリック
2. システムがドロップダウンメニューを表示
   - [編集]
   - [スキップ]
   - [削除]
3. ユーザーが「スキップ」を選択
4. システムが確認ダイアログを表示
   - 「このステップをスキップしますか？」
   - 「スキップ理由（任意）:」[テキストボックス]
   - [キャンセル] [スキップする]
5. ユーザーが「スキップする」を選択
6. システムがステップのステータスを「skipped」に更新
7. システムが目標の進捗率を再計算（スキップしたステップを除外）

**事後条件**
- ステップがスキップ状態になる
- 目標の進捗率が更新される
- ポイントは付与されない

### UC-4: 目標を編集する

**前提条件**
- ユーザーがログイン済み
- 自分が作成した目標が存在する

**正常フロー**
1. ユーザーが目標詳細画面で「編集」ボタンをクリック
2. システムが編集フォームを表示（現在の値が入力済み）
3. ユーザーが目標情報を編集
4. ユーザーがステップを追加/編集/削除（任意）
5. ユーザーが「保存」ボタンをクリック
6. システムが変更をデータベースに保存
7. システムが目標詳細画面にリダイレクト
8. システムが「目標を更新しました」という通知を表示

**事後条件**
- 目標情報が更新される

## 6. ゲーミフィケーション要素

### ポイント付与ルール

| アクション | ポイント | 備考 |
|-----------|---------|------|
| 目標作成 | 5pt | 初回のみボーナス +10pt |
| 簡単なステップ完了 | 5pt | 所要時間30分未満 |
| 中程度のステップ完了 | 10pt | 所要時間30分〜1時間 |
| 難しいステップ完了 | 20pt | 所要時間1時間以上 |
| 目標達成（小） | 50pt | ステップ3個以下 |
| 目標達成（中） | 100pt | ステップ4-6個 |
| 目標達成（大） | 200pt | ステップ7個以上 |
| 連続ログイン（ストリーク） | 1pt/日 | 3日連続で +5pt ボーナス |

### バッジ

| バッジ名 | 獲得条件 | デザインイメージ |
|---------|---------|----------------|
| はじめの一歩 | 初めての目標作成 | 👣 |
| 継続は力なり | 7日連続ログイン | 🔥 |
| 挑戦者 | 3つの目標を作成 | 🎯 |
| 達成者 | 初めての目標達成 | 🏆 |
| スーパー達成者 | 10個の目標を達成 | 🌟 |
| 関係性マスター | 関係性カテゴリの目標を5つ達成 | 🤝 |
| 多動性マスター | 多動性カテゴリの目標を5つ達成 | 🚀 |
| 感受性マスター | 感受性カテゴリの目標を5つ達成 | 💭 |
| あそとマスター | 全カテゴリで各5つ以上の目標達成 | 👑 |

### ストリーク（連続記録）

```
連続ログイン日数: 🔥 7日
現在の最長記録: 14日
過去最長記録: 21日

[月][火][水][木][金][土][日]
 ✅  ✅  ✅  ✅  ✅  ✅  ✅
```

## 7. 通知設計

### 通知タイミング

| 通知タイプ | タイミング | 内容例 |
|-----------|-----------|--------|
| リマインダー | ステップの期限1日前 | 「明日が期限です：日程調整をする」 |
| 激励 | ステップが3日間未完了 | 「あと一歩です！日程調整を完了させましょう」 |
| 祝福 | ステップ完了時 | 「ステップを完了しました！+10pt」 |
| 目標達成 | 目標完了時 | 「おめでとうございます！目標を達成しました！🎉」 |
| ストリーク | 連続ログイン達成時 | 「7日連続ログイン達成！🔥」 |
| 提案 | 新しいステップ提案時 | 「次のステップとして『○○』はいかがですか？」 |

### 通知チャネル

- **アプリ内通知**: リアルタイム
- **メール**: 日次サマリー（設定可能）
- **プッシュ通知**: 重要な通知のみ（モバイルアプリ対応時）

## 8. アクセシビリティ・UX考慮事項

### モバイル対応
- レスポンシブデザイン
- タッチフレンドリーなボタンサイズ
- スワイプジェスチャー対応（ステップ完了など）

### 操作の簡潔さ
- ワンクリック/タップでステップ完了
- ドラッグ&ドロップでステップの順序変更
- キーボードショートカット対応

### 視覚的フィードバック
- 完了時のアニメーション
- プログレスバーのスムーズな動き
- 色分けによるステータス表示（未完了=グレー、進行中=青、完了=緑）

### エラーハンドリング
- 入力エラー時の明確なメッセージ
- ネットワークエラー時のリトライ機能
- オフライン時のローカル保存

## 9. パフォーマンス考慮事項

### データ取得の最適化
- 目標一覧は最初の10件のみ表示（無限スクロール）
- ステップは目標詳細画面で遅延読み込み

### キャッシング戦略
- 目標一覧をローカルキャッシュ（1時間）
- 完了アクションは即座にUIを更新、バックグラウンドで同期

## 10. テストケース

### 単体テスト
- 目標作成のバリデーション
- 進捗率計算ロジック
- ポイント付与ロジック

### 統合テスト
- 目標作成からステップ完了までのフロー
- 全ステップ完了時の目標完了処理
- 通知送信の動作確認

### E2Eテスト
- ユーザーが目標を作成し、すべてのステップを完了するまでのシナリオ
- モバイルデバイスでの操作

## 11. 今後の拡張案

### Phase 2
- **AIステップ提案**: ユーザーの過去の行動から最適なステップを提案
- **コラボレーション目標**: 複数人で1つの目標を共有
- **テンプレートマーケットプレイス**: ユーザーが作成した目標テンプレートを共有

### Phase 3
- **音声入力**: ステップ完了やメモを音声で記録
- **Habit Tracking**: 日々の習慣を記録（毎日の瞑想、運動など）
- **目標の依存関係**: 目標A完了後に目標Bが解放される仕組み
